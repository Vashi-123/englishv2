# Исправление ошибки с пропуском уроков (Expert Review)

## Анализ проблемы

Было проведено детальное исследование проблемы "проскакивания" уроков.

**Корневая причина:**
1.  **Утечка состояния (State Leak):** В компоненте `AppContent.tsx` переменная `initialLessonProgress` используется для инициализации урока.
    - При открытии урока через меню (`handleTaskClick`) она загружается корректно.
    - Однако в функции `handleNextLesson` (переход к следующему уроку) эта переменная **не сбрасывается**.
    - В результате, при переходе от Урока 1 к Уроку 2, компонент Урока 2 получает прогресс Урока 1 (где `completed: true`).
    - Урок 2 "думает", что он уже завершен, и сразу показывает экран успеха и кнопку "Следующий урок".
    - Если пользователь нажимает быстро, он мгновенно завершает и Урок 2, переходя к Уроку 3.

2.  **Множественные нажатия (Race Condition):** Даже без утечки состояния, возможность нажать кнопку несколько раз во время анимации перехода может вызвать нежелательные эффекты (повторные запросы к API).

## Экспертная оценка решения

Предлагаемое решение состоит из двух частей:

1.  **Очистка состояния (`setInitialLessonProgress(null)`)**:
    - **Оценка:** Это **критически необходимое** изменение. Без него любой переход по "Next Lesson" будет передавать "завершенный" статус следующему уроку.
    - **Риски:** Минимальны. Новый урок просто загрузит свой реальный статус из кэша или базы данных, как при обычном открытии. Это стандартное поведение.

2.  **Блокировка кнопки (Debounce/Disable)**:
    - **Оценка:** Это стандартная практика UX (User Experience). Кнопка должна становиться неактивной сразу после первого нажатия, чтобы показать пользователю, что система приняла команду.
    - **Риски:** Нет. Это улучшает отзывчивость интерфейса.

**Вердикт:** Это решение является наиболее подходящим. Оно устраняет саму причину бага (утечку данных) и добавляет защиту от случайных действий пользователя (блокировку кнопки), не затрагивая при этом логику начисления очков или сохранения прогресса в базе данных.

## План Реализации

### 1. [AppContent.tsx] Устранение утечки состояния

В функции `handleNextLesson` необходимо сбросить `initialLessonProgress` перед переключением урока.

```typescript
// components/AppContent.tsx

const handleNextLesson = async () => {
    // ... проверки ...

    // СБРОС СОСТОЯНИЯ: Чтобы следующий урок не считался "завершенным" по наследству
    setInitialLessonProgress(null); 

    setSelectedDayId(nextPlan.day);
    // ... дальнейшая логика
};
```

### 2. [DialogueMessages.tsx] Блокировка кнопки

Добавить состояние загрузки для кнопки перехода.

```typescript
// components/step4Dialogue/DialogueMessages.tsx

// Внутри компонента
const [isNavigating, setIsNavigating] = useState(false);

// В рендере кнопки
<button
  onClick={() => {
     if (isNavigating) return;
     setIsNavigating(true);
     onNextLesson?.();
  }}
  disabled={isNavigating}
  // ... стили для disabled состояния (opacity-70 cursor-not-allowed)
>
```

## План проверки (QA)

1.  **Проверка воспроизведения (до фикса)**:
    - Пройти урок, нажать "Следующий урок". Проверить, открылся ли следующий урок сразу с экраном "Урок пройден" (если да, баг воспроизведен).
2.  **Проверка исправления**:
    - Пройти урок.
    - Нажать "Следующий урок".
    - Убедиться, что следующий урок открывается с начала (диалог, а не экран успеха).
    - Убедиться, что при нажатии кнопка визуально реагирует (становится неактивной), предотвращая двойные клики.
