# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —É—Ä–æ–∫–∞

## –û–±–∑–æ—Ä

–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —É—Ä–æ–∫–∞ (Step4DialogueScreen) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞, –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ UI.

## –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

### 1. –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)

#### 1.1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ –∫—ç—à–∞
- **peekCachedChatMessages** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏
- –ï—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `isLoading = false` –µ—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à

#### 1.2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—É–∫–æ–≤
- `useTtsQueue` - –æ—á–µ—Ä–µ–¥—å TTS
- `useLanguage` - —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- `useStep4ProgressPersistence` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ localStorage

### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —É—Ä–æ–∫–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)

#### 2.1. ensureLessonContext
**–ó–∞–ø—Ä–æ—Å—ã:**
1. `getLessonIdForDayLesson(day, lesson, level)` 
   - –ó–∞–ø—Ä–æ—Å: `supabase.from('lesson_scripts').select('lesson_id').eq('day', day).eq('lesson', lesson).eq('level', level)`
   - **1 –∑–∞–ø—Ä–æ—Å**

2. `getAuthUserIdFromSession()` –∏–ª–∏ `getOrCreateLocalUser()`
   - `supabase.auth.getSession()` (–∏–∑ –∫—ç—à–∞, –æ–±—ã—á–Ω–æ –Ω–µ —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å)
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ local user
   - **0-1 –∑–∞–ø—Ä–æ—Å**

**–ò—Ç–æ–≥–æ**: 1-2 –∑–∞–ø—Ä–æ—Å–∞

### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ (useChatInitialization)

#### 3.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
- `peekCachedChatMessages` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
- –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ, `setIsLoading(false)`

#### 3.2. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É—Ä–æ–∫–∞
**–ó–∞–ø—Ä–æ—Å:**
- `loadLessonProgress(day, lesson, level)`
  - –í–Ω—É—Ç—Ä–∏: `getLessonIdForDayLesson` (–º–æ–∂–µ—Ç –±—ã—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω)
  - –ó–∞–ø—Ä–æ—Å: `supabase.from('lesson_progress').select('current_step_snapshot, completed_at').eq('user_id', userId).eq('lesson_id', lessonId)`
  - **1 –∑–∞–ø—Ä–æ—Å**

#### 3.3. –°—Ü–µ–Ω–∞—Ä–∏–π A: –ù–æ–≤—ã–π —É—Ä–æ–∫ (–Ω–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)

**–ü—Ä–æ—Ü–µ—Å—Å—ã:**
1. `ensureLessonContext()` - –ø–æ–ª—É—á–µ–Ω–∏–µ lessonId –∏ userId
2. `ensureLessonScript()` - –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ —É—Ä–æ–∫–∞
   - `loadLessonScript(day, lesson, level)`
   - –ó–∞–ø—Ä–æ—Å: `supabase.from('lesson_scripts').select('script').eq('day', day).eq('lesson', lesson).eq('level', level)`
   - **1 –∑–∞–ø—Ä–æ—Å**
3. `createInitialLessonMessages(script)` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–ª–æ–∫–∞–ª—å–Ω–æ)
4. `appendEngineMessagesWithDelay(seeded.messages)` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
5. `upsertLessonProgress(...)` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
   - –ó–∞–ø—Ä–æ—Å: `supabase.from('lesson_progress').upsert(...)`
   - **1 –∑–∞–ø—Ä–æ—Å**

**–ò—Ç–æ–≥–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞**: 3 –∑–∞–ø—Ä–æ—Å–∞ (lesson_progress check + lesson_scripts + lesson_progress upsert)

#### 3.4. –°—Ü–µ–Ω–∞—Ä–∏–π B: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —É—Ä–æ–∫–∞ (–µ—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å)

**–ü—Ä–æ—Ü–µ—Å—Å—ã:**
1. `loadChatMessages(day, lesson, level, { preferCache: true })`
   - –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
   - –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ:
     - `getLessonIdForDayLesson` (–º–æ–∂–µ—Ç –±—ã—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω)
     - –ó–∞–ø—Ä–æ—Å: `supabase.from('chat_messages').select('id, role, text, created_at, message_order, current_step_snapshot').eq('user_id', userId).eq('lesson_id', lessonId)`
     - **1 –∑–∞–ø—Ä–æ—Å**
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ `currentStep` –∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
3. –ï—Å–ª–∏ –Ω–µ—Ç `lessonScript`:
   - `loadLessonScript(day, lesson, level)` - **1 –∑–∞–ø—Ä–æ—Å**

**–ò—Ç–æ–≥–æ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è**: 1-2 –∑–∞–ø—Ä–æ—Å–∞ (chat_messages + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ lesson_scripts)

#### 3.5. –°—Ü–µ–Ω–∞—Ä–∏–π C: Retry –ª–æ–≥–∏–∫–∞ (–µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π)

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Ö –Ω–µ—Ç, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è retry —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏:
- –ó–∞–¥–µ—Ä–∂–∫–∏: `[60ms, 140ms, 260ms]` (–∏–ª–∏ `[0ms]` –≤ debug —Ä–µ–∂–∏–º–µ)
- –ù–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏: `loadChatMessages` - **–¥–æ 3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**

### 4. Realtime –ø–æ–¥–ø–∏—Å–∫–∏ (useLessonRealtimeSubscriptions)

**–ü—Ä–æ—Ü–µ—Å—Å—ã:**
1. `subscribeChatMessages(day, lesson, callback, level)`
   - –°–æ–∑–¥–∞–Ω–∏–µ Supabase realtime –∫–∞–Ω–∞–ª–∞
   - –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è `chat_messages` –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–∫–∞
   - **WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ** (–Ω–µ HTTP –∑–∞–ø—Ä–æ—Å)

**–ò—Ç–æ–≥–æ**: 1 WebSocket –ø–æ–¥–ø–∏—Å–∫–∞

### 5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å–æ—Å—Ç–æ—è–Ω–∏—è (useStep4ProgressPersistence)

**–ü—Ä–æ—Ü–µ—Å—Å—ã (–≤—Å–µ –∏–∑ localStorage, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ):**
1. Grammar gate - –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–µ–∫—Ü–∏–∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
2. Vocabulary progress - –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞
3. Matching game - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
4. Find the mistake - –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
5. Constructor - –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

**–ò—Ç–æ–≥–æ**: 0 –∑–∞–ø—Ä–æ—Å–æ–≤ (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ localStorage)

### 6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

#### 6.1. Prefetch TTS (—Ñ–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
- –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ `lessonScript` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `prefetchTtsForLessonScript`
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ—Ä–∞–∑ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è TTS –∞—Å—Å–µ—Ç–æ–≤ –≤ –∫—ç—à–µ
- –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —á–µ—Ä–µ–∑ edge function (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

#### 6.2. Auto-scroll
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–æ–Ω—Ü—É —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π —É—Ä–æ–∫ (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
1. `getLessonIdForDayLesson` - 1 –∑–∞–ø—Ä–æ—Å
2. `loadLessonProgress` (check) - 1 –∑–∞–ø—Ä–æ—Å
3. `loadLessonScript` - 1 –∑–∞–ø—Ä–æ—Å
4. `upsertLessonProgress` - 1 –∑–∞–ø—Ä–æ—Å

**–ò—Ç–æ–≥–æ**: 4 –∑–∞–ø—Ä–æ—Å–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —É—Ä–æ–∫–∞ (–µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è)
1. `loadLessonProgress` (check) - 1 –∑–∞–ø—Ä–æ—Å
2. `loadChatMessages` - 1 –∑–∞–ø—Ä–æ—Å
3. `loadLessonScript` (–µ—Å–ª–∏ –Ω–µ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω) - 0-1 –∑–∞–ø—Ä–æ—Å

**–ò—Ç–æ–≥–æ**: 2-3 –∑–∞–ø—Ä–æ—Å–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Retry (—Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤–∏–ª–∏—Å—å –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏)
–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–æ 3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ `loadChatMessages`

**–ò—Ç–æ–≥–æ**: 2-5 –∑–∞–ø—Ä–æ—Å–æ–≤

## –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è lessonId**
   - `getLessonIdForDayLesson` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
   - –ú–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–∑–æ–≤–∞
   - **–†–µ—à–µ–Ω–∏–µ**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ lessonId –≤ –ø–∞–º—è—Ç–∏ –Ω–∞ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏

2. **Retry –ª–æ–≥–∏–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏**
   - –î–æ 3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ 60-260ms
   - –ó–∞–º–µ–¥–ª—è–µ—Ç –æ—Ç–∫—Ä—ã—Ç–∏–µ —É—Ä–æ–∫–∞
   - **–†–µ—à–µ–Ω–∏–µ**: –£–±—Ä–∞—Ç—å retry –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –±–æ–ª–µ–µ —É–º–Ω—ã–º

### üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

3. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ lesson_scripts**
   - `getLessonIdForDayLesson` –∏ `loadLessonScript` –æ–±–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç `lesson_scripts`
   - –ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
   - **–†–µ—à–µ–Ω–∏–µ**: –ó–∞–≥—Ä—É–∂–∞—Ç—å lesson_id –≤–º–µ—Å—Ç–µ —Å–æ script

4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∞—Ç—á–∏–Ω–≥–∞**
   - `loadLessonProgress` –∏ `loadChatMessages` –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
   - –ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∏–ª–∏ RPC
   - **–†–µ—à–µ–Ω–∏–µ**: RPC —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞

### üü¢ –ú–µ–ª–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

5. **–£—Å–ª–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ lessonScript**
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
   - –ù–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ–∑–∂–µ, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
   - **–†–µ—à–µ–Ω–∏–µ**: –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

6. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—ç—à–∞**
   - `peekCachedChatMessages` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
   - –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ lessonId**
   ```typescript
   const lessonIdCache = new Map<string, string>();
   // –ö—ç—à –Ω–∞ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
   ```

2. **–ë–∞—Ç—á–∏–Ω–≥ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞**
   ```sql
   CREATE FUNCTION get_lesson_init_data(
     p_user_id UUID,
     p_day INT,
     p_lesson INT,
     p_level TEXT
   ) RETURNS JSON AS $$
   -- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç lesson_id, script, progress, messages –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
   $$;
   ```

3. **–£–±—Ä–∞—Ç—å retry –ª–æ–≥–∏–∫—É**
   - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ
   - Retry —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ race condition

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –°—Ä–µ–¥–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

4. **–û–±—ä–µ–¥–∏–Ω–∏—Ç—å getLessonIdForDayLesson –∏ loadLessonScript**
   - –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö
   - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏ lesson_id, –∏ script

5. **Prefetch –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞**
   - –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–∫–∞, prefetch —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤ —Ñ–æ–Ω–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ú–µ–ª–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

6. **–£–ª—É—á—à–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ sessionStorage
   - –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

```
Step4DialogueScreen –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
‚îÇ
‚îú‚îÄ‚îÄ peekCachedChatMessages (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –ø–∞–º—è—Ç—å)
‚îÇ   ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚úÖ
‚îÇ
‚îú‚îÄ‚îÄ ensureLessonContext
‚îÇ   ‚îú‚îÄ‚îÄ getLessonIdForDayLesson ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ‚îî‚îÄ‚îÄ getAuthUserIdFromSession ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚îÇ                                          ‚îÇ
‚îú‚îÄ‚îÄ useChatInitialization                  ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ loadLessonProgress ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ getLessonIdForDayLesson (–∫—ç—à) ‚îÄ‚îê
‚îÇ   ‚îÇ                                       ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ [–°—Ü–µ–Ω–∞—Ä–∏–π A: –ù–æ–≤—ã–π —É—Ä–æ–∫]            ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ensureLessonScript              ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ loadLessonScript ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ createInitialLessonMessages     ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upsertLessonProgress            ‚îÇ
‚îÇ   ‚îÇ                                       ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ [–°—Ü–µ–Ω–∞—Ä–∏–π B: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ]          ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ loadChatMessages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ       ‚îî‚îÄ‚îÄ loadLessonScript (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ‚îÄ‚îò
‚îÇ
‚îú‚îÄ‚îÄ useLessonRealtimeSubscriptions
‚îÇ   ‚îî‚îÄ‚îÄ subscribeChatMessages (WebSocket)
‚îÇ
‚îî‚îÄ‚îÄ useStep4ProgressPersistence
    ‚îî‚îÄ‚îÄ localStorage (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
```

## –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **–ù–æ–≤—ã–π —É—Ä–æ–∫**: ~400-800ms (4 –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)
- **–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —É—Ä–æ–∫–∞**: ~200-500ms (2-3 –∑–∞–ø—Ä–æ—Å–∞)
- **–° –∫—ç—à–µ–º**: ~50-100ms (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞)

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–æ—Ü–µ–Ω–∫–∞)
- **–ù–æ–≤—ã–π —É—Ä–æ–∫**: ~200-400ms (1 RPC –∑–∞–ø—Ä–æ—Å)
- **–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —É—Ä–æ–∫–∞**: ~150-300ms (1 RPC –∑–∞–ø—Ä–æ—Å)
- **–° –∫—ç—à–µ–º**: ~50-100ms (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

## –í—ã–≤–æ–¥—ã

1. **–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è lessonId –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
2. **–í—Ç–æ—Ä–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: Retry –ª–æ–≥–∏–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ—Ç–∫—Ä—ã—Ç–∏–µ
3. **–•–æ—Ä–æ—à–æ**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
4. **–•–æ—Ä–æ—à–æ**: Realtime –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å RPC —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞
2. ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å lessonId –≤ –ø–∞–º—è—Ç–∏
3. ‚è≥ –£–±—Ä–∞—Ç—å –∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å retry –ª–æ–≥–∏–∫—É
4. ‚è≥ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã lesson_scripts

